from requests import get
from PIL import Image
from io import BytesIO
from menu import Menu

API_KEY = "dQltGlSWwxd5BUmEbGGarsHq8mss4SkudOUE5JNf"

def display_photo(url):
    """Displays the photo found at url."""
    img_resp = get(url)
    img = Image.open(BytesIO(img_resp.content))
    img.show()
    img.close()

def fetch_data(url):
    """Fetches data from a given url."""
    return get(url).json()

def get_rover_photos(rover_name, date):
    """Fetches photos taken by a rover on a given date."""
    url_photos = f"https://api.nasa.gov/mars-photos/api/v1/rovers/{rover_name}/photos?earth_date={date}&api_key={API_KEY}"
    return fetch_data(url_photos)

def show_photo_menu(photos):
    """Shows a menu of photos for the user to choose from."""
    photo_menu = Menu()
    photo_menu.set_title("Mars Rover Photos")
    photo_menu.set_prompt("Choose a photo to view:")
    photo_options = [(f"Photo {i}", display_photo, [photo['img_src']]) for i, photo in enumerate(photos['photos'], start=1)]
    photo_menu.set_options(photo_options)
    photo_menu.open()

def main_menu():
    """Shows the main menu for choosing rovers and dates."""
    main_menu = Menu()
    main_menu.set_title("Mars Rover Explorer")
    main_menu.set_prompt("Choose an option:")
    rover_options = [
        ("Curiosity", lambda: rover_date_menu("curiosity")),
        ("Opportunity", lambda: rover_date_menu("opportunity")),
        ("Spirit", lambda: rover_date_menu("spirit")),
        ("Exit", Menu.CLOSE)
    ]
    main_menu.set_options(rover_options)
    main_menu.open()

def rover_date_menu(rover_name):
    """Prompts for a date and shows the photos menu."""
    date = input(f"Enter a date (YYYY-MM-DD) for rover {rover_name}: ")
    photos = get_rover_photos(rover_name, date)
    if photos['photos']:
        show_photo_menu(photos)
    else:
        print("No photos found for this date. Try another date.")

if __name__ == "__main__":
    main_menu()
